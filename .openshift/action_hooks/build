#!/bin/bash

set -e

# Install go
# We expect the output of `go version` to be something like
# "go version go1.1.2 darwin/amd64"
GO_VERSION=`go version | awk '{split($0,a," "); print a[3]}'`
if [ "$GO_VERSION" != "go1.1.2" ]; then
  curl https://go.googlecode.com/files/go1.1.2.linux-amd64.tar.gz |
  tar zxf - -C $OPENSHIFT_DATA_DIR
fi

export GOROOT=$OPENSHIFT_DATA_DIR/go
export GOPATH=$OPENSHIFT_DATA_DIR/build
export PATH=$GOPATH/bin:$GOROOT/bin:$PATH

# Copy source code to $GOPATH's package folder
rm -rf $GOPATH 2>/dev/null
mkdir -p $GOPATH/src
cp -r $OPENSHIFT_REPO_DIR/$OPENSHIFT_APP_NAME $GOPATH/src

# Build binary and move it to $GOPATH's package folder
go install $OPENSHIFT_APP_NAME/$OPENSHIFT_APP_NAME
mv $GOPATH/bin/$OPENSHIFT_APP_NAME $GOPATH/src/$OPENSHIFT_APP_NAME
